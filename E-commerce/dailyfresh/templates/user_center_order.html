{#<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">#}
{#<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">#}
{#<head>#}
{#	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">#}
{#	<title>天天生鲜-用户中心</title>#}
{#	<link rel="stylesheet" type="text/css" href="../static/css/reset.css">#}
{#	<link rel="stylesheet" type="text/css" href="../static/css/main.css">#}
{#</head>#}
{#<body>#}
{#	<div class="header_con">#}
{#		<div class="header">#}
{#			<div class="welcome fl">欢迎来到天天生鲜!</div>#}
{#			<div class="fr">#}
{#				<div class="login_info fl">#}
{#					欢迎您：<em>张 山</em>#}
{#				</div>#}
{#				<div class="login_btn fl">#}
{#					<a href="login.html">登录</a>#}
{#					<span>|</span>#}
{#					<a href="register.html">注册</a>#}
{#				</div>#}
{#				<div class="user_link fl">#}
{#					<span>|</span>#}
{#					<a href="user_center_info.html">用户中心</a>#}
{#					<span>|</span>#}
{#					<a href="../static/cart.html">我的购物车</a>#}
{#					<span>|</span>#}
{#					<a href="user_center_order.html">我的订单</a>#}
{#				</div>#}
{#			</div>#}
{#		</div>		#}
{#	</div>#}
{##}
{#	<div class="search_bar clearfix">#}
{#		<a href="index.html" class="logo fl"><img src="../static/images/logo.png"></a>#}
{#		<div class="sub_page_name fl">|&nbsp;&nbsp;&nbsp;&nbsp;用户中心</div>#}
{#		<div class="search_con fr">#}
{#			<input type="text" class="input_text fl" name="" placeholder="搜索商品">#}
{#			<input type="button" class="input_btn fr" name="" value="搜索">#}
{#		</div>		#}
{#	</div>#}
{##}
{#	<div class="main_con clearfix">#}
{#		<div class="left_menu_con clearfix">#}
{#			<h3>用户中心</h3>#}
{#			<ul>#}
{#				<li><a href="user_center_info.html">· 个人信息</a></li>#}
{#				<li><a href="user_center_order.html" class="active">· 全部订单</a></li>#}
{#				<li><a href="user_center_site.html">· 收货地址</a></li>#}
{#			</ul>#}
{#		</div>#}
{#		<div class="right_content clearfix">#}
{#				<h3 class="common_title2">全部订单</h3>#}
{#				<ul class="order_list_th w978 clearfix">#}
{#					<li class="col01">2016-8-21 17:36:24</li>#}
{#					<li class="col02">订单号：56872934</li>#}
{#					<li class="col02 stress">未支付</li>		#}
{#				</ul>#}
{##}
{#				<table class="order_list_table w980">#}
{#					<tbody>#}
{#						<tr>#}
{#							<td width="55%">#}
{#								<ul class="order_goods_list clearfix">					#}
{#									<li class="col01"><img src="../static/images/goods02.jpg"></li>#}
{#									<li class="col02">嘎啦苹果嘎啦苹果<em>11.80元/500g</em></li>	#}
{#									<li class="col03">1</li>#}
{#									<li class="col04">11.80元</li>	#}
{#								</ul>#}
{#								<ul class="order_goods_list clearfix">					#}
{#									<li class="col01"><img src="../static/images/goods02.jpg"></li>#}
{#									<li class="col02">嘎啦苹果嘎啦苹果<em>11.80元/500g</em></li>	#}
{#									<li class="col03">1</li>#}
{#									<li class="col04">11.80元</li>	#}
{#								</ul>#}
{#							</td>#}
{#							<td width="15%">33.60元</td>#}
{#							<td width="15%">待付款</td>#}
{#							<td width="15%"><a href="#" class="oper_btn">去付款</a></td>#}
{#						</tr>#}
{#					</tbody>#}
{#				</table>#}
{#				#}
{#				<ul class="order_list_th w978 clearfix">#}
{#					<li class="col01">2016-8-21 17:36:24</li>#}
{#					<li class="col02">订单号：56872934</li>#}
{#					<li class="col02 stress">已支付</li>			#}
{#				</ul>#}
{#				<table class="order_list_table w980">#}
{#					<tbody>#}
{#						<tr>#}
{#							<td width="55%">#}
{#								<ul class="order_goods_list clearfix">					#}
{#									<li class="col01"><img src="../static/images/goods02.jpg"></li>#}
{#									<li class="col02">嘎啦苹果嘎啦苹果<em>11.80元/500g</em></li>	#}
{#									<li class="col03">1</li>#}
{#									<li class="col04">11.80元</li>	#}
{#								</ul>#}
{#								<ul class="order_goods_list clearfix">					#}
{#									<li class="col01"><img src="../static/images/goods02.jpg"></li>#}
{#									<li class="col02">嘎啦苹果嘎啦苹果<em>11.80元/500g</em></li>	#}
{#									<li class="col03">1</li>#}
{#									<li class="col04">11.80元</li>	#}
{#								</ul>#}
{#							</td>#}
{#							<td width="15%">33.60元</td>#}
{#							<td width="15%">已付款</td>#}
{#							<td width="15%"><a href="#" class="oper_btn">查看物流</a></td>#}
{#						</tr>#}
{#					</tbody>#}
{#				</table>#}
{##}
{#				<div class="pagenation">#}
{#					<a href="#"><上一页</a>#}
{#					<a href="#" class="active">1</a>#}
{#					<a href="#">2</a>#}
{#					<a href="#">3</a>#}
{#					<a href="#">4</a>#}
{#					<a href="#">5</a>#}
{#					<a href="#">下一页></a>#}
{#				</div>#}
{#		</div>#}
{#	</div>#}
{##}
{##}
{##}
{#	<div class="footer">#}
{#		<div class="foot_link">#}
{#			<a href="#">关于我们</a>#}
{#			<span>|</span>#}
{#			<a href="#">联系我们</a>#}
{#			<span>|</span>#}
{#			<a href="#">招聘人才</a>#}
{#			<span>|</span>#}
{#			<a href="#">友情链接</a>		#}
{#		</div>#}
{#		<p>CopyRight © 2016 北京天天生鲜信息技术有限公司 All Rights Reserved</p>#}
{#		<p>电话：010-****888    京ICP备*******8号</p>#}
{#	</div>#}
{#	#}
{#</body>#}
{#</html>#}

{% extends "base_user_center.html" %}
{% load staticfiles %}
{% block right_content %}
   <div class="right_content clearfix">
    {% csrf_token %}
				<h3 class="common_title2">全部订单</h3>
                {% for order in  order_page %}
				<ul class="order_list_th w978 clearfix">
					<li class="col01">{{ order.create_time }}</li>
					<li class="col02">订单号：{{ order.order_id }}</li>
					<li class="col02 stress">{{ order.status_name }}</li>
				</ul>

				<table class="order_list_table w980">
					<tbody>
						<tr>
							<td width="55%">
                                {% for order_sku in order.order_skus %}
								<ul class="order_goods_list clearfix">
									<li class="col01"><img src="{{ order_sku.sku.image.url }}"></li>
									<li class="col02">{{ order_sku.sku.name }}<em>{{ order_sku.price }}元/{{ order_sku.sku.unite }}</em></li>
									<li class="col03">{{ order_sku.count }}</li>
									<li class="col04">{{ order_sku.amount }}元</li>
								</ul>
                                    {% endfor %}
							</td>
							<td width="15%">{{ order.total_price|add:order.transit_price }}(含运费:{{ order.transit_price }})元</td>
							<td width="15%">{{ order.status_name }}</td>
							<td width="15%"><a href="javascript:;" order_id="{{ order.order_id }}" status="{{ order.order_status }}" class="oper_btn">去付款</a></td>
						</tr>
					</tbody>
				</table>
                {% endfor %}

				<div class="pagenation">
                    {% if order_page.has_previous_page %}
                    <a href="{% url 'user:order'  order_page.previous_page_number %}">上一页</a>
                    {% endif %}
                     {% for pindex in pages %}
                        {% if pindex == order_page.number %}
                            <a href="{% url 'user:order' pindex %}" class="active">{{ pindex }}</a>
                        {% else %}
                             <a href="{% url 'user:order' pindex %}">{{ pindex }}</a>
                        {% endif %}
                    {% endfor %}
    {#            has_next 返回下一页代码，next_page_number下一页代码#}
                    {% if order_page.has_next_page %}
                        <a href="{% url 'user:order' order_page.next_page_number %}">下一页</a>
                    {% endif %}
				</div>
		</div>
{% endblock right_content %}
{% block bottomfiles %}
    <script type="text/javascript" src="{% static 'js/jquery-1.12.4.min.js' %}"></script>
    <script type="text/javascript">
        $(".oper_btn").each(function () {
            //获取支付状态，修改的按钮那3个字 去付款，收发货 去评价 已完成
            status = $(this).attr('status');
            if(status == 1){
                $(this).text("去支付")
            } else if(status == 4){
                $(this).text("去评价")
            }else if(status == 5){
                $(this).text("已完成")
            }
        })

        $('.oper_btn').click(function () {
            status = $(this).attr('status');
            order_id=$(this).attr('order_id');
            if (status == 1){
                //进行支付
                csrf=$('input[name="csrfmiddlewaretoken"]').val();
                //组织参数
                params={"order_id":order_id ,"csrfmiddlewaretoken":csrf}
                //发起ajax post 请求 访问/order/pay 传递参数 order_id
                $.post('/order/pay',params,function (data) {
                    if (data.res==3){
                        //引导用户到支付页面
                        window.open(data.pay_url) //再打开一个浏览器窗口
                        //浏览器访问/order/check 获取支付交易的结果
                        $.post('/order/check',params,function (data) {
                            if(data.res == 3){
                                //刷新页面
                                location.reload()
                            }else{
                                alert(data.errmsg)
                            }


                        })
                    }else{
                        alert(data.errmsg)
                    }
                })
            }else if (status == 4){
                //其它情况
                //跳转到评价页面
                location.href = "/order/comment" + order_id
            }
        })
    </script>
{% endblock bottomfiles %}
