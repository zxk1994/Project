<div>
{#<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">#}
{#<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">#}
{#<head>#}
{#	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">#}
{#	<title>天天生鲜-购物车</title>#}
{#	<link rel="stylesheet" type="text/css" href="css/reset.css">#}
{#	<link rel="stylesheet" type="text/css" href="css/main.css">#}
{#</head>#}
{#<body>#}
{#	<div class="header_con">#}
{#		<div class="header">#}
{#			<div class="welcome fl">欢迎来到天天生鲜!</div>#}
{#			<div class="fr">#}
{#				<div class="login_info fl">#}
{#					欢迎您：<em>张 山</em>#}
{#				</div>#}
{#				<div class="login_btn fl">#}
{#					<a href="../templates/login.html">登录</a>#}
{#					<span>|</span>#}
{#					<a href="../templates/register.html">注册</a>#}
{#				</div>#}
{#				<div class="user_link fl">#}
{#					<span>|</span>#}
{#					<a href="../templates/user_center_info.html">用户中心</a>#}
{#					<span>|</span>#}
{#					<a href="cart.html">我的购物车</a>#}
{#					<span>|</span>#}
{#					<a href="../templates/user_center_order.html">我的订单</a>#}
{#				</div>#}
{#			</div>#}
{#		</div>		#}
{#	</div>#}
{##}
{#	<div class="search_bar clearfix">#}
{#		<a href="../templates/index.html" class="logo fl"><img src="images/logo.png"></a>#}
{#		<div class="sub_page_name fl">|&nbsp;&nbsp;&nbsp;&nbsp;购物车</div>#}
{#		<div class="search_con fr">#}
{#			<input type="text" class="input_text fl" name="" placeholder="搜索商品">#}
{#			<input type="button" class="input_btn fr" name="" value="搜索">#}
{#		</div>		#}
{#	</div>#}
{##}
{#	<div class="total_count">全部商品<em>2</em>件</div>	#}
{#	<ul class="cart_list_th clearfix">#}
{#		<li class="col01">商品名称</li>#}
{#		<li class="col02">商品单位</li>#}
{#		<li class="col03">商品价格</li>#}
{#		<li class="col04">数量</li>#}
{#		<li class="col05">小计</li>#}
{#		<li class="col06">操作</li>#}
{#	</ul>#}
{#	<ul class="cart_list_td clearfix">#}
{#		<li class="col01"><input type="checkbox" name="" checked></li>#}
{#		<li class="col02"><img src="images/goods/goods012.jpg"></li>#}
{#		<li class="col03">奇异果<br><em>25.80元/500g</em></li>#}
{#		<li class="col04">500g</li>#}
{#		<li class="col05">25.80元</li>#}
{#		<li class="col06">#}
{#			<div class="num_add">#}
{#				<a href="javascript:;" class="add fl">+</a>#}
{#				<input type="text" class="num_show fl" value="1">	#}
{#				<a href="javascript:;" class="minus fl">-</a>	#}
{#			</div>#}
{#		</li>#}
{#		<li class="col07">25.80元</li>#}
{#		<li class="col08"><a href="javascript:;">删除</a></li>#}
{#	</ul>#}
{##}
{#	<ul class="cart_list_td clearfix">#}
{#		<li class="col01"><input type="checkbox" name="" checked></li>#}
{#		<li class="col02"><img src="images/goods/goods003.jpg"></li>#}
{#		<li class="col03">大兴大棚草莓<br><em>16.80元/500g</em></li>#}
{#		<li class="col04">500g</li>#}
{#		<li class="col05">16.80元</li>#}
{#		<li class="col06">#}
{#			<div class="num_add">#}
{#				<a href="javascript:;" class="add fl">+</a>#}
{#				<input type="text" class="num_show fl" value="1">	#}
{#				<a href="javascript:;" class="minus fl">-</a>	#}
{#			</div>#}
{#		</li>#}
{#		<li class="col07">16.80元</li>#}
{#		<li class="col08"><a href="javascript:;">删除</a></li>#}
{#	</ul>#}
{#	#}
{##}
{#	<ul class="settlements">#}
{#		<li class="col01"><input type="checkbox" name="" checked=""></li>#}
{#		<li class="col02">全选</li>#}
{#		<li class="col03">合计(不含运费)：<span>¥</span><em>42.60</em><br>共计<b>2</b>件商品</li>#}
{#		<li class="col04"><a href="place_order.html">去结算</a></li>#}
{#	</ul>#}
{##}
{#	<div class="footer">#}
{#		<div class="foot_link">#}
{#			<a href="#">关于我们</a>#}
{#			<span>|</span>#}
{#			<a href="#">联系我们</a>#}
{#			<span>|</span>#}
{#			<a href="#">招聘人才</a>#}
{#			<span>|</span>#}
{#			<a href="#">友情链接</a>		#}
{#		</div>#}
{#		<p>CopyRight © 2016 北京天天生鲜信息技术有限公司 All Rights Reserved</p>#}
{#		<p>电话：010-****888    京ICP备*******8号</p>#}
{#	</div>#}
{#	#}
{#</body>#}
{#</html>#}
</div>

{% extends 'base_no_cart.html' %}
{% load staticfiles %}
{% block title %}天天生鲜-购物车{% endblock title %}
{% block page_title %}购物车{% endblock page_title %}
{% block body %}

	<div class="total_count">全部商品<em>{{ total_count }}</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>
     <form method="post" action="{% url 'order:place' %}">
    {% for sku in skus %}
	<ul class="cart_list_td clearfix">
		<li class="col01"><input type="checkbox" name="sku_ids" value="{{ sku.id }}" checked></li>
		<li class="col02"><img src="{{ sku.image.url }}"></li>
		<li class="col03">{{ sku.name }}<br><em>{{ sku.price }}元/{{ sku.unite }}</em></li>
		<li class="col04">{{ sku.unite }}</li>
		<li class="col05">{{ sku.price }}元</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="add fl">+</a>
				<input type="text" sku_id="{{ sku.id }}" class="num_show fl" value="{{ sku.count }}">
				<a href="javascript:;" class="minus fl">-</a>
			</div>
		</li>
		<li class="col07">{{ sku.amount }}元</li>
		<li class="col08"><a href="javascript:;">删除</a></li>
	</ul>
    {% endfor %}
	<ul class="settlements">
        {% csrf_token %}
		<li class="col01"><input type="checkbox" name="" checked=""></li>
		<li class="col02">全选</li>
        <li class="col03">合计(不含运费)：<span>￥</span><em>{{ total_price }}</em><br>共计<b>{{ total_count }}</b>件商品</li>
		<li class="col04"><input type="submit" value="去结算" class="jiesuan"></li>
	</ul>
    </form>
{% endblock body %}
{% block bottomfiles %}
    <script type="text/javascript" src="{% static 'js/jquery-1.12.4.min.js' %}"></script>
    <script type="text/javascript">
        //封装函数--计算被选中的商品的总件数和总价格
        function update_page_info() {
            //获取所有被选中商品的checkbox
            //获取所有被选中商品所在的ul元素
            total_count = 0;
            total_price = 0;
            $('.cart_list_td').find(':checked').parents('ul').each(function () {
                //获取商品的数目和小计
                count = $(this).find('.num_show').val();
                amount = $(this).children('.col07').text();
                //累加计算商品的总件数和总价格
                count=parseInt(count);
                amount=parseFloat(amount);
                total_count += count;
                total_price += amount;
            });
            //设置被选中的商品的总件数和总价格
            $(".settlements").find("em").text(total_price.toFixed(2));
            $(".settlements").find("b").text(total_count);
        }

        //再封装一个函数用于更新小计
        function update_page_amount(sku_ul) {
            //先来获取商品的价格和数量
            count=sku_ul.find(".num_show").val();
            price=sku_ul.children(".col05").text(); //col(字母l)  05
            //计算
            amount=parseInt(count)*parseFloat(price);
            //更新
            sku_ul.children(".col07").text(amount.toFixed(2)+"元");
        }

        //商品的全选和全不选
        $(".settlements").find(":checkbox").change(function () {
            //获取全选的checkbox的选中状态
            is_checked =$(this).prop("checked");
            //遍历商品对应的checkbox，设置这些checkbox的选中状态和全选的checkbox保持一致
            $(".cart_list_td").find(":checkbox").each(function () {
                $(this).prop("checked",is_checked)
            });
            //更新页面的信息
            update_page_info();
        });

        //商品对应的checkbox状态发生改变时，设置全选checkbox状态
        $(".cart_list_td").find(":checkbox").change(function () {
            //获取页面上所有商品的数目
            all_len=$(".cart_list_td").length;
            //获取页面上被选中的商品的数目
            checked_len =$(".cart_list_td").find(":checkbox").length;
            is_checked = true;
            if(checked_len < all_len){
                is_checked = false;
            }
            $(".settlements").find(":checkbox").prop('checked',is_checked);
             //更新页面的信息
            update_page_info();
        })


        //购物车商品数目的增加
        $('.add').click(function () {
            //先来获取参数 商品的id 商品中的数量 csrf
            sku_id = $(this).next().attr("sku_id");
            count = $(this).next().val();
            csrf=$("input[name='csrfmiddlewaretoken']").val();

            //组织参数
            params = {"sku_id":sku_id,"count":parseInt(count)+1,"csrfmiddlewaretoken":csrf};
            _this = $(this)
            $.post("{% url 'cart:update' %}",params,function(data){
                if(data.res==5){
                    _this.next().val(parseInt(count)+1);
                    update_page_amount(_this.parents("ul"));  //更新小计
                    update_page_info()  //更新总计与总数量
                    $(".total_count").children("em").text(data.total_count)//设置左上角购物车同步的
                }else{
                    alert(data.errmsg)
                }
            },'json')
        })


         //购物车商品数目的减少  prev 上一个 减号
        $('.minus').click(function () {
            //先来获取参数 商品的id 商品中的数量 csrf
            sku_id = $(this).prev().attr("sku_id");
            count = $(this).prev().val();
            csrf=$("input[name='csrfmiddlewaretoken']").val();
            count = parseInt(count)-1;
            if(count<=0){
                return
            }

            //组织参数
            params = {"sku_id":sku_id,"count":count,"csrfmiddlewaretoken":csrf};
            _this = $(this);
            $.post("{% url 'cart:update' %}",params,function(data){
                if(data.res==5){
                    _this.prev().val(count);
                    update_page_amount(_this.parents("ul"));  //更新小计
                    update_page_info();  //更新总计与总数量
                    $(".total_count").children("em").text(data.total_count)//设置左上角购物车同步的
                }else{
                    alert(data.errmsg)
                }
            },'json')
        })

        //记录用户输入之前商品的数量
        pre_count = 0;
        $(".num_show").focus(function () {
            pre_count =$(this).val()
        });

        //手动输入商品的数量
        $('.num_show').blur(function () {
            //先来获取参数 商品的id 商品中的数量 csrf
            sku_id = $(this).attr("sku_id");
            count = $(this).val();
            csrf=$("input[name='csrfmiddlewaretoken']").val();

            //检查参数
            if(isNaN(count) || count.trim().length ==0 || parseInt(count) <=0){
                $(this).val(pre_count);  //不满足条件，失去焦点，显示原值
                return
            }
            //更新购物车的记录
            count=parseInt(count);

            //组织参数
            params = {"sku_id":sku_id,"count":count,"csrfmiddlewaretoken":csrf};
            _this = $(this);
            $.post("{% url 'cart:update' %}",params,function(data){
                if(data.res==5){
                    _this.prev().val(count);
                    update_page_amount(_this.parents("ul"));  //更新小计
                    update_page_info();  //更新总计与总数量
                    $(".total_count").children("em").text(data.total_count)//设置左上角购物车同步的
                }else{
                    alert(data.errmsg)
                    $(_this).val(pre_count) //不满足条件、失去焦点显示原值
                }
            },'json')
        })


        //删除购物车中的记录
        $('.cart_list_td').children('.col08').children("a").click(function () {
            //先来获取参数 商品的id 商品中的数量 csrf
            sku_id = $(this).parents('ul').find('.num_show').attr("sku_id");
            csrf=$("input[name='csrfmiddlewaretoken']").val();
            //组织参数
            params = {"sku_id":sku_id,"csrfmiddlewaretoken":csrf};
            //获取商品所在的ul元素
            _this=$(this).parents("ul");
            $.post("{% url 'cart:delete' %}",params,function(data){
                if(data.res==5){
                    //删除成功
                    _this.remove();
                    //更新页面信息
                     update_page_info();  //更新总计与总数量

                    //重新设置总件数
                    $(".total_count").children("em").text(data.total_count)//设置左上角购物车同步的
                }else{
                    alert(data.errmsg)
                }
            },'json')
        })

    </script>
{% endblock bottomfiles %}

